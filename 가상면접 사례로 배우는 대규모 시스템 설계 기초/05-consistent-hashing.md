# 5. 안정 해시 설계

규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는게 중요하다. 안정 해시는 이를 위해 보편적으로 사용하는 기술이다.

## 해시 키 재배치 문제

모듈러 연산을 이용하는 방법은 일반적이지만, 서버 증설 / 감소 시 문제가 생긴다.

ex) 서버 인덱스 N으로 모듈러 하는 경우, 서버 감소 시 연산 결과가 달라져 대규모 캐시 미스가 발생할 수 있다.

## 안정 해시

안정 해시는 해시 테이블 크기가 조절될 때 k/n 개의 캐시만 재배치하는 해시 기술이다. (n은 슬롯의 갯수이다.) 이에반해 전통적 해시 테이블은 슬롯 수가 바뀔 때 거의 대부분 키를 재배치한다.

### 해시 공간과 해시 링

안정 해시의 동작은 단순하다.

- hash space를 ring 구조로 정의한다. 시작인 0번의 hash space와 끝인 N번 hash space는 맞닿아 있다.
- 각 서버의 ip등을 hashing하여 ring 위에 X개 배치시킨다.
- 각 key를 hashing하여 ring 위에 Y개 배치시킨다.
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버이다.

이는 중간에 서버가 늘어나거나 줄어도, 일부 키만 다음 서버로 이동되기 때문에 대규모 재배치가 일어나지 않는다.

그러나 이 방법에도 다음과 같은 문제가 있다.

1. 파티션의 크기를 균등히 유지할 수 없다.
2. 키의 균등 분포를 달성할 수 없다.

#### 가상 노드

가상 노드는 위 문제를 해결하기 위한 기법이다.

이는 실제 서버보다 많은 가상의 노드를 링 위에 배치시킨다. 더 많은 수의 서버를 배치한 것처럼 hash space를 잘게 쪼개고, 각 파티션을 담당하게 한다.

ex) A0, B0, C0라는 노드가 있는 경우 → A1, B1, C1의 가상 노드를 추가할 수 있다.

키가 A1이라는 가상 노드를 만나면 해당 키는 A0에 저장된다. 이를 통해 (서버마다 할당되는) 키의 분포가 점점 균등해지는 효과를 얻을 수 있다.

## 결론

안정 해시는 다음과 같은 이점을 가진다.

- 서버 추가/삭제 시 재배치되는 키의 수를 최소화
- 데이터가 균등하게 분포되어 수평적 확장 달성에 용이
- 핫스팟 문제 감소