# 8. URL 단축기 설계

tiny url 등 URL 단축기를 설계하는 문제

## 문제 이해 및 설계 범위 확정

1. URL 단축: 주어진 긴 URL을 짧게 줄인다.
2. URL 리디렉션: 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내한다.
3. 높은 가용성과 규모 확장성, 장애 감내

### 개략적 추정

- 쓰기 연산: 매일 1억개의 단축 URL 생성 → 초당 쓰기 연산 1,160회
- 읽기 연산: 쓰기의 10배로 가정 → 초당 11,600회
- 10년간 운영을 가정할 때 약 3650억 레코드 보관 필요
- 축약 전 URL는 평균 100으로 가정 → 10년 간 필요한 저장 용량은 36.5TB로 가정

## 개략적 설계안 제시 및 동의 구하기

### API 엔드포인트

클라이언트는 서버가 제공하는 API endpoint를 통해 서버와 통신한다.

URL 단축기는 다음 두 개의 endpoint를 필요로 한다.

1. 단축용 엔드포인트: 새 단축 URL 생성
    
    ```plain
    POST /api/v1/data/shorten
    
    {
      "longURL": longURLString
    }
    
    반환: 단축 URL
    ```
    
2. 리디렉션용 엔드포인트: 단축 URL 요청이 오면 원래 URL로 보내주기 위한 엔드포인트
    
    ```plain
    GET /api/v1/shortUrl
    
    반환: 목적지가 될 원래 URL
    ```
    

### URL 리디렉션

단축 URL을 받은 서버는 URL을 원래의 URL로 바꾸어서 301응답의 Location 헤더에 넣어서 반환한다.

#### 301응답과 302응답의 차이

301응답

해당 URL에 대한 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었음을 의미한다. 브라우저는 이 응답을 캐시하고, 추후 동일 요청에 대해 원래의 URL로 요청을 보낸다.

- 서버 부하를 줄여야할 때 사용

302응답

해당 URL에 대한 요청의 처리 책임이 일시적으로 Location 헤더에 반환된 URL로 이전되었음을 의미한다. 클라이언트의 요청은 항상 단축 URL 서버에 먼저 보내진 후, 원래 URL로 리디렉션 된다.

- 트래픽 분석이 중요할 때 사용

### URL 단축

URL리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것이다. → <단축 URL, 원래 URL>

결국 중요한 것은 값을 단축 URL로 전환시킬 해시함수를 찾는 것이다.

해시 함수 요구사항

- 입력이 다른 경우 출력도 달라야한다.
- 해시 값은 다시 원래의 URL로 복원될 수 있어야 한다.

## 상세 설계

### 데이터 모델

실제 시스템에서는 메모리에 모든 정보를 관리할 수 없다. 더 나은 방법은 별도의 DB를 사용하는 것이다.

일단 id, shortURL, longURL 세 개 칼럼을 갖는 테이블을 가정한다.

### 해시 함수

원래 URL을 단축 URL로 변환하는 함수이다. 편의상 단축 URL 값을 hashValue라고 지칭한다.

#### 해시 값 길이

hashValue는 62개(알파벳+숫자) 문자로 구성된다. 시스템은 3650억 개의 URL을 만들 수 있어야 하기 때문에 최소한 hashValue의 길이가 7이 되어야 한다. (62^7 == 3.5조)

#### 해시 후 충돌 해소

CRC32, MD5, SHA-1 등의 잘 알려진 해시 함수를 사용하는 경우 아무리 짧아도 7보다 긴 문자열이 나온다. 이를 어떻게 줄일 수 있을까?

1. 계산된 해시 값에서 처음7개 글자만 이용
2. 충돌이 발생하는 경우 (DB에 존재하는 경우) → longURL 뒤에 사전에 정한 문자열 추가 → 해시 재계산

이 방법을 사용하면 충돌은 해소할 수 있지만, URL 생성마다 DB 질의가 발생하므로 오버헤드가 크다. 이 때 블룸 필터를 사용하면 성능을 높일 수 있다.

#### base-62 변환

longURL → 10진수 UUID 생성 → UUID를 62진수 변환

#### 두 접근법 비교

1. 길이
    
    충돌 해소 전략은 단축URL 길이가 고정되지만, base 62에서는 길이가 가변적이다.
    
2. 요구사항
    
    충돌 해소 전략은 유일성이 보장되는 ID생성기가 필요하지 않지만, base 62에서는 필요하다.
    
3. 충돌
    
    충돌 해소 전략은 충돌이 가능하고, 해소 전략이 필요하지만, base 62에서는 충돌이 불가능하다.
    
4. 보안
    
    base 62에서는 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 유추 가능하다.
    

### URL 단축기 상세 설계

1. 입력으로 긴 URL을 받는다.
    
2. DB에 해당 URL이 있는지 검사한다.
    
3. 값이 있다면 단축 URL을 가져와서 반환한다.
    
4. 값이 없다면 유일 ID를 생성한다.
    
5. 62진법 변환 적용 → ID를 단축 URL로 만든다.
    
6. ID, 단축 URL, 원래 URL로 새 DB 레코드를 만든 후 새 단축 URL을 클라이언트에 반환한다.
    

> ID 생성기는 전역적 유일성을 보장해야 한다. (7장 참조)    

### URL 리디렉션 상세 설계

1. 사용자가 단축 URL을 클릭
2. 로드밸런서는 요청을 웹 서버로 전달
3. 단축 URL이 캐시에 있는 경우 원래 URL을 꺼내서 클라이언트에 전달
4. 캐시에 없는 경우 DB에서 조회 (없는 경우 요청실패)
5. 값을 캐시에 저장 후 클라이언트에 전달

## 마무리

추가 논의해볼만 한 사항

1. 처리율 제한 장치
    
    많은 수의 요청이 밀려드는 경우에 대한 대응, 필터링 규칙을 이용해 요청을 걸러낼 수 있다.
    
2. 규모 확장
    
    웹 서버: 무상태 웹 서버로 자유롭게 규모 확장 가능
    
    DB: 다중화, 샤딩 등을 통한 규모 확장 가능
    
3. 데이터 분석 솔루션
    
    단축기에 데이터 분석 솔루션을 통합하여 사용자 통계 등의 정보를 알 수 있다.
    
4. CAP